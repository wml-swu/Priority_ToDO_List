# 发布流程：打 tag 后自动构建并上传到 GitHub Releases，用户可直接下载使用（无需 Xcode）
name: Release

on:
  push:
    tags:
      - 'v*'   # 例如 v1.0.0

jobs:
  build-and-release:
    runs-on: macos-14
    permissions:
      contents: write   # 创建 Release 并上传附件
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 项目使用 Xcode 16 的 project format (77)，需指定 Xcode 16+
      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16'

      - name: Build Archive
        env:
          # CI 无 Apple 开发者证书，禁用代码签名
          CODE_SIGN_IDENTITY: "-"
          CODE_SIGNING_REQUIRED: "NO"
          CODE_SIGNING_ALLOWED: "NO"
          DEVELOPMENT_TEAM: ""
        run: |
          xcodebuild -scheme priority_list \
            -configuration Release \
            -destination 'generic/platform=macOS' \
            -archivePath "$PWD/build/priority_list.xcarchive" \
            clean archive

      - name: Export .app
        run: |
          xcodebuild -exportArchive \
            -archivePath "$PWD/build/priority_list.xcarchive" \
            -exportPath "$PWD/build/Release" \
            -exportOptionsPlist "$PWD/scripts/ExportOptions.plist"

      - name: Zip app
        run: |
          cd build/Release
          zip -r -y "$GITHUB_WORKSPACE/Do-it-Release.zip" priority_list.app

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          files: Do-it-Release.zip
          generate_release_notes: false
          body: |
            ## 直接下载使用（无需 Xcode）
            1. 下载 **Do-it-Release.zip**
            2. 解压得到 `priority_list.app`
            3. 拖到「应用程序」文件夹
            4. 从菜单栏右侧点击 Do it! 图标即可使用
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
